<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hyperliquid Portfolio Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', Roboto, sans-serif;
            background: #ffffff;
            min-height: 100vh;
            padding: 20px;
            color: #1a1a1a;
            line-height: 1.6;
        }
        
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: #ffffff;
            padding: 40px 20px;
        }
        
        h1 {
            text-align: center;
            color: #1a1a1a;
            margin-bottom: 10px; /* Reduced margin */
            font-size: 28px;
            font-weight: 600;
            letter-spacing: -0.5px;
        }

        /* Static subheading styles */
        .subheading {
            text-align: center;
            color: #6b7280;
            margin-bottom: 40px;
            font-size: 16px;
            font-weight: normal;
        }
        
        .input-section {
            background: #f8f9fa;
            padding: 24px;
            border-radius: 8px;
            margin-bottom: 30px;
            border: 1px solid #e9ecef;
        }
        
        .input-group {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 15px;
            align-items: end;
            margin-bottom: 15px;
        }
        
        label {
            font-weight: 500;
            color: #4a4a4a;
            margin-bottom: 6px;
            display: block;
            font-size: 14px;
        }
        
        input, select {
            padding: 12px 16px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 15px;
            transition: border-color 0.2s ease;
            background: #ffffff;
            font-family: inherit;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: #1a1a1a;
        }
        
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
        }
        
        .btn-primary {
            background: #1a1a1a;
            color: white;
        }
        
        .btn-primary:hover {
            background: #333333;
        }
        
        .btn-secondary {
            background: #f3f4f6;
            color: #4a4a4a;
            border: 1px solid #d1d5db;
        }
        
        .btn-secondary:hover {
            background: #e5e7eb;
            color: #1a1a1a;
        }
        
        /* Updated styles for centering control buttons */
        .controls {
            display: flex;
            justify-content: center; /* Center buttons horizontally */
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .portfolio-table {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid #e5e7eb;
            margin-bottom: 20px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: #f9fafb;
            color: #374151;
            padding: 16px;
            text-align: left;
            font-weight: 500;
            font-size: 14px;
            border-bottom: 1px solid #e5e7eb;
        }
        
        td {
            padding: 16px;
            border-bottom: 1px solid #f3f4f6;
            font-size: 14px;
        }
        
        tr:hover {
            background: #f9fafb;
        }
        
        .price {
            font-weight: 500;
            color: #059669;
        }
        
        .value {
            font-weight: 500;
            color: #1a1a1a;
        }
        
        .loading {
            text-align: center;
            padding: 40px 20px;
            color: #6b7280;
            font-style: normal;
        }
        
        .error {
            background: #fef2f2;
            color: #dc2626;
            padding: 12px 16px;
            border-radius: 6px;
            margin: 10px 0;
            border: 1px solid #fecaca;
            font-size: 14px;
        }
        
        .success {
            background: #f0fdf4;
            color: #166534;
            padding: 12px 16px;
            border-radius: 6px;
            margin: 10px 0;
            border: 1px solid #bbf7d0;
            font-size: 14px;
        }
        
        .total-value {
            background: #f9fafb;
            color: #1a1a1a;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 500;
            border: 1px solid #e5e7eb;
        }
        
        /* Updated styles for centering chart container content */
        .chart-container {
            display: flex;
            flex-direction: column;
            align-items: center; /* Center items horizontally */
            margin: 0 auto 30px auto; /* Center the entire container */
            background: #f9fafb;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #e5e7eb;
            max-width: 600px; /* Limit width for better centering */
        }
        
        .chart-title {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 15px;
            color: #374151;
            text-align: center; /* Ensure title text is centered */
            width: 100%;
        }
        
        .pie-chart {
            position: relative;
            width: 250px;
            height: 250px;
            margin: 0 auto 20px auto; /* Center the pie chart */
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .pie-chart svg {
            display: block; /* Remove any inline spacing */
            margin: 0 auto; /* Center the SVG */
        }
        
        .legend {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 15px;
            margin-top: 10px;
            width: 100%;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            font-size: 14px;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            margin-right: 5px;
            border-radius: 2px;
        }
        
        .history-section {
            margin-top: 30px;
        }
        
        .history-title {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 15px;
            color: #374151;
        }
        
        .edit-quantity {
            display: flex;
            gap: 5px;
        }
        
        .edit-quantity input {
            width: 80px;
            padding: 5px;
            font-size: 12px;
        }
        
        .edit-quantity button {
            padding: 5px;
            font-size: 12px;
        }
        
        @media (max-width: 768px) {
            .input-group {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
                align-items: center; /* Center buttons vertically on small screens */
            }
            
            table {
                font-size: 14px;
            }
            
            th, td {
                padding: 8px;
            }
            
            .pie-chart {
                width: 200px;
                height: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Hyperliquid Portfolio Tracker</h1>
        
        <!-- Static subheading (replace with your desired text) -->
        <h2 class="subheading">
            Free, fast, and private â€” real-time crypto portfolio tracking in a single HTML file.<br>
        No backend, no frameworks, just you and your browser.</h2>
        
        <div class="input-section">
            <div class="input-group">
                <div>
                    <label for="assetSelect">Asset</label>
                    <select id="assetSelect">
                        <option value="">Select Asset</option>
                    </select>
                </div>
                <div>
                    <label for="quantityInput">Quantity</label>
                    <input type="number" id="quantityInput" placeholder="0.00" step="0.001">
                </div>
                <div>
                    <button class="btn btn-primary" onclick="addAsset()">Add Asset</button>
                </div>
            </div>
        </div>
        
        <div class="controls">
            <button class="btn btn-primary" onclick="refreshPrices()">Refresh Prices</button>
            <button class="btn btn-secondary" onclick="downloadHistoryCSV()">Download History CSV</button>
            <button class="btn btn-secondary" onclick="clearPortfolio()">Clear All</button>
        </div>
        
        <div id="totalValue" class="total-value" style="display: none;">
            Total Portfolio Value: $<span id="totalAmount">0.00</span>
        </div>
        
        <div id="chartContainer" class="chart-container" style="display: none;">
            <div class="chart-title">Portfolio Allocation</div>
            <div id="pieChart" class="pie-chart"></div>
            <div id="chartLegend" class="legend"></div>
        </div>
        
        <div id="messages"></div>
        
        <div class="portfolio-table">
            <table>
                <thead>
                    <tr>
                        <th>Asset</th>
                        <th>Quantity</th>
                        <th>Current Price</th>
                        <th>Value (USD)</th>
                        <th>Allocation %</th>
                        <th>Last Updated</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="portfolioBody">
                    <tr>
                        <td colspan="7" class="loading">Add assets to start tracking your portfolio</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Portfolio data stored in memory
        let portfolio = [];
        let priceCache = {};
        let portfolioHistory = [];
        let priceUpdateInterval;
        let tokenMapping = {};
        
        // Colors for pie chart
        const chartColors = [
            '#3366CC', '#DC3912', '#FF9900', '#109618', '#990099', 
            '#0099C6', '#DD4477', '#66AA00', '#B82E2E', '#316395', 
            '#994499', '#22AA99', '#AAAA11', '#6633CC', '#E67300', 
            '#8B0707', '#329262', '#5574A6', '#3B3EAC'
        ];

        // Load portfolio from localStorage on page load
        window.onload = function() {
            loadPortfolio();
            loadAvailableAssets();
            startAutoRefresh();
        };
        
        // Start auto-refresh of prices
        function startAutoRefresh() {
            // Clear any existing interval
            if (priceUpdateInterval) {
                clearInterval(priceUpdateInterval);
            }
            
            // Set interval to refresh prices every 60 seconds
            priceUpdateInterval = setInterval(() => {
                if (portfolio.length > 0) {
                    refreshPrices(true); // silent refresh
                }
            }, 60000); // 60 seconds
        }

        // Save portfolio to localStorage
        function savePortfolio() {
            localStorage.setItem('hyperliquid_portfolio', JSON.stringify(portfolio));
            localStorage.setItem('hyperliquid_portfolio_history', JSON.stringify(portfolioHistory));
        }

        // Load portfolio from localStorage
        function loadPortfolio() {
            const saved = localStorage.getItem('hyperliquid_portfolio');
            const savedHistory = localStorage.getItem('hyperliquid_portfolio_history');
            
            if (saved) {
                portfolio = JSON.parse(saved);
                updatePortfolioDisplay();
            }
            
            if (savedHistory) {
                portfolioHistory = JSON.parse(savedHistory);
            }
        }

        // Load available assets from Hyperliquid
        async function loadAvailableAssets() {
            try {
                // First, try to get token metadata for better naming
                try {
                    const metaResponse = await fetch('https://api.hyperliquid.xyz/info', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({type: 'spotMeta'})
                    });
                    
                    const metaData = await metaResponse.json();
                    
                    // Create token mapping
                    tokenMapping = {};
                    for (const token of metaData.universe) {
                        const name = token.name;
                        const index = token.index;
                        const fullName = token.fullName;
                        
                        // For tokens with @ prefix, use the proper name if available
                        let displayName;
                        if (name.startsWith('@')) {
                            // Special cases for common tokens
                            if (index === 2) {
                                displayName = 'LICK';
                            } else if (index === 3) {
                                displayName = 'MANLET';
                            } else if (index === 4) {
                                displayName = 'JEFF';
                            } else if (index === 1) {
                                displayName = 'HFUN';
                            } else if (fullName) {
                                displayName = fullName;
                            } else {
                                displayName = name;
                            }
                        } else {
                            // For tokens with proper names, use the name directly
                            displayName = name;
                        }
                        
                        tokenMapping[name] = {
                            name: name,
                            display: displayName,
                            index: index
                        };
                    }
                } catch (metaError) {
                    console.error('Error loading token metadata:', metaError);
                }
                
                // Get all available assets with prices
                const response = await fetch('https://api.hyperliquid.xyz/info', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({type: 'allMids'})
                });
                
                const data = await response.json();
                const select = document.getElementById('assetSelect');
                
                // Clear existing options except the first one
                while (select.children.length > 1) {
                    select.removeChild(select.lastChild);
                }
                
                // Add USD as the first option
                const usdOption = document.createElement('option');
                usdOption.value = 'USD';
                usdOption.textContent = 'USD';
                select.appendChild(usdOption);
                
                // Prepare assets for sorting
                const assets = Object.keys(data).map(asset => {
                    let displayName = asset;
                    if (tokenMapping[asset]) {
                        displayName = tokenMapping[asset].display;
                    }
                    return { value: asset, display: displayName };
                });
                
                // Sort assets by display name, but prioritize common tokens
                const priorityTokens = ['BTC', 'ETH', 'SOL', 'HYPE', 'PURR'];
                assets.sort((a, b) => {
                    const aIsPriority = priorityTokens.includes(a.display);
                    const bIsPriority = priorityTokens.includes(b.display);
                    
                    if (aIsPriority && !bIsPriority) return -1;
                    if (!aIsPriority && bIsPriority) return 1;
                    if (aIsPriority && bIsPriority) {
                        return priorityTokens.indexOf(a.display) - priorityTokens.indexOf(b.display);
                    }
                    
                    return a.display.localeCompare(b.display);
                });
                
                // Add all assets to dropdown
                assets.forEach(asset => {
                    const option = document.createElement('option');
                    option.value = asset.value;
                    option.textContent = asset.display;
                    select.appendChild(option);
                });
                
            } catch (error) {
                showMessage('Could not load available assets. Using default list.', 'error');
                console.error('Error loading assets:', error);
                
                // Ensure USD is still available even if API fails
                const select = document.getElementById('assetSelect');
                if (select.children.length <= 1) {
                    const usdOption = document.createElement('option');
                    usdOption.value = 'USD';
                    usdOption.textContent = 'USD';
                    select.appendChild(usdOption);
                }
            }
        }

        // Get display name for an asset
        function getDisplayName(asset) {
            if (asset === 'USD') {
                return 'USD';
            }
            if (tokenMapping[asset]) {
                return tokenMapping[asset].display;
            }
            return asset;
        }

        // Add asset to portfolio
        function addAsset() {
            const asset = document.getElementById('assetSelect').value;
            const quantity = parseFloat(document.getElementById('quantityInput').value);
            
            if (!asset || !quantity || quantity <= 0) {
                showMessage('Please select an asset and enter a valid quantity', 'error');
                return;
            }
            
            // Check if asset already exists
            const existingIndex = portfolio.findIndex(item => item.asset === asset);
            
            if (existingIndex >= 0) {
                // Update existing asset
                portfolio[existingIndex].quantity = quantity;
                portfolio[existingIndex].lastUpdated = new Date().toLocaleString();
                showMessage(`Updated ${getDisplayName(asset)} in portfolio`, 'success');
            } else {
                // Add new asset
                portfolio.push({
                    asset: asset,
                    quantity: quantity,
                    price: asset === 'USD' ? 1 : 0, // USD always has price of $1
                    value: asset === 'USD' ? quantity : 0, // USD value is always equal to quantity
                    allocation: 0,
                    lastUpdated: new Date().toLocaleString()
                });
                showMessage(`Added ${getDisplayName(asset)} to portfolio`, 'success');
            }
            
            // Record the change in history
            portfolioHistory.push({
                timestamp: new Date().toISOString(),
                action: existingIndex >= 0 ? 'UPDATE' : 'ADD',
                asset: asset,
                displayAsset: getDisplayName(asset),
                quantity: quantity,
                price: asset === 'USD' ? 1 : 0,
                value: asset === 'USD' ? quantity : 0
            });
            
            // Clear inputs
            document.getElementById('assetSelect').value = '';
            document.getElementById('quantityInput').value = '';
            
            savePortfolio();
            refreshPrices();
        }

        // Refresh prices from Hyperliquid API
        async function refreshPrices(silent = false) {
            if (portfolio.length === 0) {
                if (!silent) {
                    showMessage('No assets in portfolio to refresh', 'error');
                }
                return;
            }
            
            if (!silent) {
                showMessage('Refreshing prices...', 'success');
            }
            
            try {
                const response = await fetch('https://api.hyperliquid.xyz/info', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({type: 'allMids'})
                });
                
                const prices = await response.json();
                priceCache = prices;
                
                // Update portfolio with new prices
                let totalValue = 0;
                let pricesUpdated = false;
                
                portfolio.forEach(item => {
                    // USD always has a fixed price of $1
                    const price = item.asset === 'USD' ? 1 : parseFloat(prices[item.asset] || 0);
                    
                    // Check if price has changed
                    if (price !== item.price) {
                        pricesUpdated = true;
                    }
                    
                    item.price = price;
                    item.value = item.quantity * price;
                    item.lastUpdated = new Date().toLocaleString();
                    totalValue += item.value;
                });
                
                // Calculate allocations
                portfolio.forEach(item => {
                    item.allocation = totalValue > 0 ? (item.value / totalValue) * 100 : 0;
                });
                
                // Record portfolio snapshot in history if prices changed
                if (pricesUpdated) {
                    const timestamp = new Date().toISOString();
                    
                    // Record total portfolio value
                    portfolioHistory.push({
                        timestamp: timestamp,
                        action: 'PORTFOLIO_SNAPSHOT',
                        totalValue: totalValue
                    });
                    
                    savePortfolio();
                }
                
                updatePortfolioDisplay();
                updatePieChart();
                
                if (!silent) {
                    showMessage('Prices updated successfully!', 'success');
                }
                
            } catch (error) {
                if (!silent) {
                    showMessage('Failed to fetch prices from Hyperliquid API', 'error');
                    console.error('API Error:', error);
                }
                
                // Even if API fails, ensure USD price is still $1
                portfolio.forEach(item => {
                    if (item.asset === 'USD') {
                        item.price = 1;
                        item.value = item.quantity;
                        item.lastUpdated = new Date().toLocaleString();
                    }
                });
                
                // Recalculate total value and allocations
                const totalValue = portfolio.reduce((sum, item) => sum + item.value, 0);
                portfolio.forEach(item => {
                    item.allocation = totalValue > 0 ? (item.value / totalValue) * 100 : 0;
                });
                
                updatePortfolioDisplay();
                updatePieChart();
            }
        }

        // Update portfolio display
        function updatePortfolioDisplay() {
            const tbody = document.getElementById('portfolioBody');
            const totalElement = document.getElementById('totalValue');
            const totalAmount = document.getElementById('totalAmount');
            const chartContainer = document.getElementById('chartContainer');
            
            if (portfolio.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="loading">Add assets to start tracking your portfolio</td></tr>';
                totalElement.style.display = 'none';
                chartContainer.style.display = 'none';
                return;
            }
            
            let totalValue = portfolio.reduce((sum, item) => sum + item.value, 0);
            
            tbody.innerHTML = portfolio.map((item, index) => `
                <tr>
                    <td><strong>${getDisplayName(item.asset)}</strong></td>
                    <td>${item.quantity.toFixed(6)}</td>
                    <td class="price">$${item.price.toFixed(2)}</td>
                    <td class="value">$${item.value.toFixed(2)}</td>
                    <td>${item.allocation.toFixed(1)}%</td>
                    <td>${item.lastUpdated}</td>
                    <td>
                        <div class="edit-quantity">
                            <input type="number" id="editQuantity${index}" value="${item.quantity}" step="0.001" min="0">
                            <button class="btn btn-secondary" onclick="updateQuantity(${index})" style="padding: 5px 10px; font-size: 12px;">Update</button>
                        </div>
                        <button class="btn btn-secondary" onclick="removeAsset(${index})" style="padding: 5px 10px; font-size: 12px; margin-top: 5px;">Remove</button>
                    </td>
                </tr>
            `).join('');
            
            totalAmount.textContent = totalValue.toFixed(2);
            totalElement.style.display = 'block';
            chartContainer.style.display = 'block';
        }

        // Update quantity of an asset
        function updateQuantity(index) {
            const quantityInput = document.getElementById(`editQuantity${index}`);
            const newQuantity = parseFloat(quantityInput.value);
            
            if (!newQuantity || newQuantity <= 0) {
                showMessage('Please enter a valid quantity', 'error');
                return;
            }
            
            const asset = portfolio[index];
            const oldQuantity = asset.quantity;
            
            // Update quantity
            asset.quantity = newQuantity;
            asset.value = asset.price * newQuantity;
            asset.lastUpdated = new Date().toLocaleString();
            
            // Record the change in history
            portfolioHistory.push({
                timestamp: new Date().toISOString(),
                action: 'QUANTITY_CHANGE',
                asset: asset.asset,
                displayAsset: getDisplayName(asset.asset),
                oldQuantity: oldQuantity,
                newQuantity: newQuantity
            });
            
            // Update portfolio display
            updatePortfolioDisplay();
            updatePieChart();
            savePortfolio();
            
            showMessage(`Updated quantity of ${getDisplayName(asset.asset)} to ${newQuantity}`, 'success');
        }

        // Update pie chart
        function updatePieChart() {
            if (portfolio.length === 0) {
                return;
            }
            
            const pieChart = document.getElementById('pieChart');
            const legend = document.getElementById('chartLegend');
            
            // Clear previous chart and legend
            pieChart.innerHTML = '';
            legend.innerHTML = '';
            
            // Create SVG element
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('width', '100%');
            svg.setAttribute('height', '100%');
            svg.setAttribute('viewBox', '0 0 100 100');
            pieChart.appendChild(svg);
            
            // Filter out assets with zero value
            const validAssets = portfolio.filter(item => item.value > 0);
            
            if (validAssets.length === 0) {
                return;
            }
            
            // Calculate total value
            const totalValue = validAssets.reduce((sum, item) => sum + item.value, 0);
            
            // Sort assets by value (descending)
            validAssets.sort((a, b) => b.value - a.value);
            
            // Draw pie chart
            let startAngle = 0;
            validAssets.forEach((item, index) => {
                const percentage = item.value / totalValue;
                const endAngle = startAngle + percentage * 360;
                
                // Calculate path
                const x1 = 50 + 40 * Math.cos(Math.PI * startAngle / 180);
                const y1 = 50 + 40 * Math.sin(Math.PI * startAngle / 180);
                const x2 = 50 + 40 * Math.cos(Math.PI * endAngle / 180);
                const y2 = 50 + 40 * Math.sin(Math.PI * endAngle / 180);
                
                // Create path element
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                const largeArcFlag = percentage > 0.5 ? 1 : 0;
                
                path.setAttribute('d', `M 50 50 L ${x1} ${y1} A 40 40 0 ${largeArcFlag} 1 ${x2} ${y2} Z`);
                path.setAttribute('fill', chartColors[index % chartColors.length]);
                path.setAttribute('stroke', '#ffffff');
                path.setAttribute('stroke-width', '1');
                
                // Add tooltip
                path.setAttribute('data-asset', getDisplayName(item.asset));
                path.setAttribute('data-value', `$${item.value.toFixed(2)}`);
                path.setAttribute('data-percentage', `${(percentage * 100).toFixed(1)}%`);
                
                svg.appendChild(path);
                
                // Add to legend
                const legendItem = document.createElement('div');
                legendItem.className = 'legend-item';
                
                const colorBox = document.createElement('div');
                colorBox.className = 'legend-color';
                colorBox.style.backgroundColor = chartColors[index % chartColors.length];
                
                const text = document.createElement('span');
                text.textContent = `${getDisplayName(item.asset)} (${(percentage * 100).toFixed(1)}%)`;
                
                legendItem.appendChild(colorBox);
                legendItem.appendChild(text);
                legend.appendChild(legendItem);
                
                startAngle = endAngle;
            });
        }

        // Remove asset from portfolio
        function removeAsset(index) {
            const asset = portfolio[index];
            portfolio.splice(index, 1);
            
            // Record the removal
            portfolioHistory.push({
                timestamp: new Date().toISOString(),
                action: 'REMOVE',
                asset: asset.asset,
                displayAsset: getDisplayName(asset.asset),
                quantity: asset.quantity,
                price: asset.price,
                value: asset.value
            });
            
            updatePortfolioDisplay();
            updatePieChart();
            savePortfolio();
            showMessage(`Removed ${getDisplayName(asset.asset)} from portfolio`, 'success');
        }

        // Clear entire portfolio
        function clearPortfolio() {
            if (confirm('Are you sure you want to clear the entire portfolio?')) {
                portfolio = [];
                portfolioHistory.push({
                    timestamp: new Date().toISOString(),
                    action: 'CLEAR_ALL'
                });
                updatePortfolioDisplay();
                savePortfolio();
                showMessage('Portfolio cleared', 'success');
            }
        }
        
        // Download history as CSV
        function downloadHistoryCSV() {
            if (portfolioHistory.length === 0) {
                showMessage('No history data to download', 'error');
                return;
            }
            
            // Prepare CSV data
            let csvContent = 'Timestamp,Action,Asset,Quantity,Old Quantity,New Quantity,Total Value\n';
            
            // Filter history to only include ADD, REMOVE, QUANTITY_CHANGE, and PORTFOLIO_SNAPSHOT
            const filteredHistory = portfolioHistory.filter(record => 
                record.action === 'ADD' || 
                record.action === 'REMOVE' || 
                record.action === 'QUANTITY_CHANGE' || 
                record.action === 'PORTFOLIO_SNAPSHOT'
            );
            
            filteredHistory.forEach(record => {
                const assetName = record.displayAsset || record.asset || '';
                let row = `"${record.timestamp}",${record.action},`;
                
                if (record.action === 'PORTFOLIO_SNAPSHOT') {
                    // For portfolio snapshots, only include timestamp, action, and total value
                    row += `,,,,${record.totalValue}\n`;
                } else if (record.action === 'QUANTITY_CHANGE') {
                    // For quantity changes, include old and new quantity
                    row += `${assetName},,${record.oldQuantity},${record.newQuantity},\n`;
                } else {
                    // For add/remove, include asset and quantity
                    row += `${assetName},${record.quantity || ''},,,,\n`;
                }
                
                csvContent += row;
            });
            
            // Download file
            downloadCSV(csvContent, `hyperliquid_history_${new Date().toISOString().split('T')[0]}.csv`);
            showMessage('History CSV downloaded successfully!', 'success');
        }
        
        // Generic CSV download function
        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // Show message to user
        function showMessage(message, type) {
            const messagesDiv = document.getElementById('messages');
            const messageElement = document.createElement('div');
            messageElement.className = type;
            messageElement.textContent = message;
            messagesDiv.appendChild(messageElement);
            
            setTimeout(() => {
                messagesDiv.removeChild(messageElement);
            }, 5000);
        }
    </script>
</body>
</html>
